<div class="leads-controls">
  <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É" />
  <select id="statusFilter">
    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
    <option value="new">–ù–æ–≤—ã–π</option>
    <option value="in-work">–í —Ä–∞–±–æ—Ç–µ</option>
    <option value="done">–ó–∞–∫—Ä—ã—Ç</option>
  </select>
  <select id="affiliateFilter">
    <option value="">–í—Å–µ –∞—Ñ—Ñ–∏–ª–∏–∞—Ç—ã</option>
  </select>
  <select id="perPageSelect">
    <option>10</option>
    <option>20</option>
    <option>30</option>
    <option>50</option>
    <option>100</option>
  </select>
</div>

<div id="leadsList"></div>
<div id="paginationControls"></div>

<script>
function initLeads() {
  const currentUser = JSON.parse(localStorage.getItem("crmCurrentUser"));
  const leadsList = document.getElementById("leadsList");
  const paginationControls = document.getElementById("paginationControls");
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const affiliateFilter = document.getElementById("affiliateFilter");
  const perPageSelect = document.getElementById("perPageSelect");

  let currentPage = 1;

  const render = () => {
    const all = JSON.parse(localStorage.getItem("crmClients")) || [];
    const clients = currentUser.role === "admin" ? all : all.filter(c => c.manager === currentUser.login);

    const filtered = clients.filter(c => {
      const q = searchInput.value.toLowerCase();
      return (
        (!statusFilter.value || c.status === statusFilter.value) &&
        (!affiliateFilter.value || c.affiliate === affiliateFilter.value) &&
        (
          c.name.toLowerCase().includes(q) ||
          c.surname.toLowerCase().includes(q) ||
          c.email.toLowerCase().includes(q) ||
          c.phone.toLowerCase().includes(q)
        )
      );
    });

    const perPage = +perPageSelect.value;
    const start = (currentPage - 1) * perPage;
    const pageClients = filtered.slice(start, start + perPage);

    leadsList.innerHTML = pageClients.map(c => `
      <div class="lead-card">
        <div class="lead-left">
          <strong>${c.name} ${c.surname}</strong><br/>
          üìû ${c.phone} <br/>
          ‚úâÔ∏è ${c.email} <br/>
          üåç ${c.country} <br/>
          üè∑Ô∏è ${c.affiliate || "–ë–µ–∑ –∞—Ñ—Ñ–∏–ª–∏–∞—Ç–∞"} <br/>
          üïí ${new Date(c.createdAt || Date.now()).toLocaleDateString()}
        </div>
        <div class="lead-right">
          <label>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ:
            <input type="datetime-local" onchange="saveReminder(${c.id}, this.value)" />
            <input type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" onchange="saveReminderComment(${c.id}, this.value)" />
          </label>
          <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:
            <textarea onchange="saveLeadComment(${c.id}, this.value)">${c.comment || ""}</textarea>
          </label>
          <label>–°—Ç–∞—Ç—É—Å:
            <select onchange="saveStatus(${c.id}, this.value)">
              <option value="new" ${c.status === "new" ? "selected" : ""}>–ù–æ–≤—ã–π</option>
              <option value="in-work" ${c.status === "in-work" ? "selected" : ""}>–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="done" ${c.status === "done" ? "selected" : ""}>–ó–∞–∫—Ä—ã—Ç</option>
            </select>
          </label>
        </div>
      </div>
    `).join("");

    const totalPages = Math.ceil(filtered.length / perPage);
    paginationControls.innerHTML = Array.from({ length: totalPages }, (_, i) => `
      <button ${i + 1 === currentPage ? 'disabled' : ''} onclick="goToPage(${i + 1})">${i + 1}</button>
    `).join("");
  };

  window.goToPage = page => {
    currentPage = page;
    render();
  };

  window.saveReminder = (id, date) => {
    const clients = JSON.parse(localStorage.getItem("crmClients")) || [];
    const idx = clients.findIndex(c => c.id === id);
    if (!clients[idx].reminders) clients[idx].reminders = [];
    const last = clients[idx].reminders.at(-1);
    const comment = last?.comment || clients[idx].comment || "";
    clients[idx].reminders.push({ datetime: date, comment });
    localStorage.setItem("crmClients", JSON.stringify(clients));
    render();
  };

  window.saveReminderComment = (id, text) => {
    const clients = JSON.parse(localStorage.getItem("crmClients")) || [];
    const idx = clients.findIndex(c => c.id === id);
    const r = clients[idx].reminders?.at(-1);
    if (r) r.comment = text;
    localStorage.setItem("crmClients", JSON.stringify(clients));
  };

  window.saveLeadComment = (id, text) => {
    const clients = JSON.parse(localStorage.getItem("crmClients")) || [];
    const idx = clients.findIndex(c => c.id === id);
    clients[idx].comment = text;
    localStorage.setItem("crmClients", JSON.stringify(clients));
  };

  window.saveStatus = (id, value) => {
    const clients = JSON.parse(localStorage.getItem("crmClients")) || [];
    const idx = clients.findIndex(c => c.id === id);
    clients[idx].status = value;
    localStorage.setItem("crmClients", JSON.stringify(clients));
    render();
  };

  // populate affiliates
  const all = JSON.parse(localStorage.getItem("crmClients")) || [];
  const affiliates = [...new Set(all.map(c => c.affiliate).filter(Boolean))];
  affiliateFilter.innerHTML += affiliates.map(a => `<option value="${a}">${a}</option>`).join("");

  // listeners
  [searchInput, statusFilter, affiliateFilter, perPageSelect].forEach(e => {
    e.addEventListener("input", () => {
      currentPage = 1;
      render();
    });
  });

  render();
}
</script>
