<div class="leads-wrapper">
  <h2><i class="fa fa-address-book"></i> <span data-i18n="myLeads">Мои лиды</span></h2>

  <div class="leads-filters">
    <input type="text" id="searchInput" placeholder="Search..." />
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option value="new">New</option>
      <option value="call-back">Call back</option>
      <option value="done">Done</option>
    </select>
    <select id="affiliateFilter">
      <option value="">All affiliates</option>
      <option value="Alpha">Alpha</option>
      <option value="Beta">Beta</option>
    </select>
    <select id="itemsPerPage">
      <option value="5">Show 5</option>
      <option value="10" selected>Show 10</option>
      <option value="20">Show 20</option>
    </select>
  </div>

  <table id="clientsTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Status</th>
        <th>Affiliate</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination">
    <button id="prevPage">←</button>
    <span id="pageInfo"></span>
    <button id="nextPage">→</button>
  </div>
</div>

<script>
  function initLeadsPage() {
    loadClients();

    document.getElementById("searchInput").oninput = loadClients;
    document.getElementById("statusFilter").onchange = loadClients;
    document.getElementById("affiliateFilter").onchange = loadClients;
    document.getElementById("itemsPerPage").onchange = () => {
      currentPage = 1;
      loadClients();
    };

    document.getElementById("prevPage").onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        loadClients();
      }
    };

    document.getElementById("nextPage").onclick = () => {
      if (currentPage < totalPages) {
        currentPage++;
        loadClients();
      }
    };
  }

  let currentPage = 1;
  let totalPages = 1;

  function loadClients() {
    const user = JSON.parse(localStorage.getItem("crmCurrentUser"));
    const allClients = JSON.parse(localStorage.getItem("crmClients") || "[]");
    const search = document.getElementById("searchInput").value.toLowerCase();
    const status = document.getElementById("statusFilter").value;
    const affiliate = document.getElementById("affiliateFilter").value;
    const perPage = +document.getElementById("itemsPerPage").value;

    let filtered = allClients.filter(c => {
      const matchUser = user.role === "admin" || c.manager === user.login;
      const matchSearch = c.name.toLowerCase().includes(search) || c.email.toLowerCase().includes(search) || c.phone.includes(search);
      const matchStatus = !status || c.status === status;
      const matchAff = !affiliate || c.affiliate === affiliate;
      return matchUser && matchSearch && matchStatus && matchAff;
    });

    totalPages = Math.ceil(filtered.length / perPage);
    const from = (currentPage - 1) * perPage;
    const to = from + perPage;

    const tbody = document.querySelector("#clientsTable tbody");
    tbody.innerHTML = "";

    filtered.slice(from, to).forEach(c => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${c.name} ${c.surname}</td>
        <td>${c.phone}</td>
        <td>${c.email}</td>
        <td>${c.status}</td>
        <td>${c.affiliate}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById("pageInfo").textContent = `Page ${currentPage} of ${totalPages}`;
  }
</script>
