<section class="settings-panel">
  <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>

  <div class="admin-block">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –≤—Ä—É—á–Ω—É—é</h3>
    <input id="name" placeholder="–ò–º—è" />
    <input id="surname" placeholder="–§–∞–º–∏–ª–∏—è" />
    <input id="email" placeholder="Email" />
    <input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
    <input id="country" placeholder="–°—Ç—Ä–∞–Ω–∞" />
    <input id="affiliate" placeholder="–ê—Ñ—Ñ–∏–ª–∏–∞—Ç" />
    <select id="assignManager"></select>
    <button onclick="addClient()">–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</button>
  </div>

  <div class="admin-block">
    <h3>–ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</h3>
    <input type="file" id="csvFile" />
    <button onclick="importCSV()">–ò–º–ø–æ—Ä—Ç CSV</button>
    <button onclick="exportCSV()">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
  </div>

  <div class="admin-block">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</h3>
    <input id="managerLogin" placeholder="–õ–æ–≥–∏–Ω" />
    <input id="managerPass" placeholder="–ü–∞—Ä–æ–ª—å" />
    <button onclick="addManager()">–î–æ–±–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞</button>
  </div>

  <div class="admin-block">
    <h3>–õ–æ–≥–∏</h3>
    <div id="logsBox" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;"></div>
  </div>
</section>

<script>
function initSettingsPage() {
  const managers = (JSON.parse(localStorage.getItem("crmUsers")) || []).filter(u => u.role === "manager");
  const assignSelect = document.getElementById("assignManager");
  assignSelect.innerHTML = managers.map(m => `<option value="${m.login}">${m.login}</option>`).join("");

  const logs = JSON.parse(localStorage.getItem("crmLogs") || "[]");
  document.getElementById("logsBox").innerHTML = logs.reverse().map(log => `<div>üìÖ ${log}</div>`).join("");
}

function addClient() {
  const fields = ["name", "surname", "email", "phone", "country", "affiliate"];
  const values = {};
  fields.forEach(f => values[f] = document.getElementById(f).value.trim());
  values.manager = document.getElementById("assignManager").value;
  values.status = "new";
  values.id = Date.now();
  values.reminders = [];
  values.createdAt = new Date().toISOString();

  const clients = JSON.parse(localStorage.getItem("crmClients") || "[]");
  clients.push(values);
  localStorage.setItem("crmClients", JSON.stringify(clients));
  saveLog(`–î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç: ${values.name} ${values.surname}`);
  alert("–ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
}

function addManager() {
  const login = document.getElementById("managerLogin").value.trim();
  const password = document.getElementById("managerPass").value.trim();
  const users = JSON.parse(localStorage.getItem("crmUsers") || "[]");

  if (users.find(u => u.login === login)) {
    alert("–¢–∞–∫–æ–π –ª–æ–≥–∏–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
    return;
  }

  users.push({ login, password, role: "manager" });
  localStorage.setItem("crmUsers", JSON.stringify(users));
  saveLog(`–î–æ–±–∞–≤–ª–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä: ${login}`);
  alert("–ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
}

function saveLog(text) {
  const logs = JSON.parse(localStorage.getItem("crmLogs") || "[]");
  logs.push(`${new Date().toLocaleString()} ‚Äî ${text}`);
  localStorage.setItem("crmLogs", JSON.stringify(logs));
}

function importCSV() {
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª");

  const reader = new FileReader();
  reader.onload = () => {
    const lines = reader.result.split("\n");
    const clients = JSON.parse(localStorage.getItem("crmClients") || "[]");
    lines.forEach(line => {
      const [name, surname, email, phone, country, affiliate, manager] = line.split(",");
      if (name && surname) {
        clients.push({
          id: Date.now() + Math.random(),
          name, surname, email, phone, country, affiliate, manager,
          status: "new",
          reminders: [],
          createdAt: new Date().toISOString()
        });
      }
    });
    localStorage.setItem("crmClients", JSON.stringify(clients));
    saveLog(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–≤: ${lines.length}`);
    alert("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω");
  };
  reader.readAsText(file);
}

function exportCSV() {
  const clients = JSON.parse(localStorage.getItem("crmClients") || "[]");
  const csv = clients.map(c => [
    c.name, c.surname, c.email, c.phone, c.country, c.affiliate, c.manager
  ].join(",")).join("\n");

  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "clients_export.csv";
  a.click();
}
</script>
