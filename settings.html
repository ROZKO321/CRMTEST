<div class="admin-settings">
  <h2><i class="fa fa-cog"></i> <span data-i18n="adminSettings">Настройки администратора</span></h2>

  <div class="admin-actions">
    <button onclick="addClient()" class="btn green">Добавить клиента</button>
    <input type="file" id="uploadFile" />
    <button onclick="exportCSV()" class="btn">Экспорт CSV</button>
  </div>

  <div class="manager-assign">
    <label><input type="checkbox" id="selectAll"> Выбрать всех</label>
    <select id="managerSelect"></select>
    <button onclick="assignToManager()" class="btn dark">Назначить выбранным</button>
  </div>

  <button onclick="viewLogs()" class="btn orange">Просмотр логов</button>

  <h3 style="margin-top:20px">Add Manager Account</h3>
  <input type="text" id="newLogin" placeholder="Login" />
  <input type="password" id="newPass" placeholder="Password" />
  <button onclick="addManager()" class="btn blue">Add</button>
</div>

<script>
  function initSettingsPage() {
    const user = JSON.parse(localStorage.getItem("crmCurrentUser"));
    if (user?.role !== "admin") {
      document.getElementById("appWrapper").innerHTML = "<p>Access denied</p>";
      return;
    }

    const managers = (JSON.parse(localStorage.getItem("crmUsers")) || []).filter(u => u.role === "manager");
    const select = document.getElementById("managerSelect");
    select.innerHTML = `<option value="">-- Assign Manager --</option>`;
    managers.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.login;
      opt.textContent = m.login;
      select.appendChild(opt);
    });
  }

  function addClient() {
    const clients = JSON.parse(localStorage.getItem("crmClients") || "[]");
    const newClient = {
      id: Date.now(),
      name: "New",
      surname: "Client",
      phone: "+0000000000",
      email: "new@client.com",
      country: "Unknown",
      affiliate: "None",
      status: "new",
      comment: "",
      reminders: [],
      manager: ""
    };
    clients.push(newClient);
    localStorage.setItem("crmClients", JSON.stringify(clients));
    alert("Клиент добавлен");
  }

  function assignToManager() {
    const manager = document.getElementById("managerSelect").value;
    if (!manager) return alert("Выберите менеджера");

    const clients = JSON.parse(localStorage.getItem("crmClients") || "[]");
    clients.forEach(c => c.manager = manager);
    localStorage.setItem("crmClients", JSON.stringify(clients));
    alert("Назначение выполнено");
  }

  function addManager() {
    const login = document.getElementById("newLogin").value.trim();
    const pass = document.getElementById("newPass").value.trim();
    if (!login || !pass) return alert("Введите логин и пароль");

    const users = JSON.parse(localStorage.getItem("crmUsers") || "[]");
    if (users.some(u => u.login === login)) return alert("Такой логин уже существует");

    users.push({ login, password: pass, role: "manager" });
    localStorage.setItem("crmUsers", JSON.stringify(users));
    alert("Менеджер добавлен");
  }

  function exportCSV() {
    const clients = JSON.parse(localStorage.getItem("crmClients") || "[]");
    const headers = Object.keys(clients[0]);
    const rows = clients.map(c => headers.map(h => `"${c[h]}"`).join(","));
    const blob = new Blob([[headers.join(",") + "\n" + rows.join("\n")]], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "clients.csv";
    a.click();
  }

  function viewLogs() {
    alert("Пока логов нет. Логика добавления логов будет позже.");
  }
</script>
